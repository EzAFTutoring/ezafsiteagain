<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PDF Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#1e1f24; --panel:#2b2f37; --ink:#e9ecf1; --muted:#aab0bc; --btn:#1f2229; --bd:#444; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{display:flex;flex-direction:column;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .toolbar{
      position:sticky;top:0;z-index:10;display:flex;flex-wrap:wrap;align-items:center;gap:8px;
      padding:10px;background:var(--panel);border-bottom:1px solid #000
    }
    .toolbar .spacer{flex:1}
    .toolbar button,.toolbar input,.toolbar select,.toolbar a{
      background:var(--btn);color:var(--ink);border:1px solid var(--bd);border-radius:6px;padding:6px 10px;text-decoration:none
    }
    .toolbar input[type="number"]{width:4.5rem}
    .label{color:var(--muted)}
    #viewer{
      flex:1;overflow:auto;display:flex;justify-content:center;align-items:flex-start;gap:18px;padding:18px;
      background:linear-gradient(#1e1f24,#1e1f24) padding-box,
                 repeating-linear-gradient(0deg,#2e313a 0 1px,transparent 1px 80px),
                 repeating-linear-gradient(90deg,#2e313a 0 1px,transparent 1px 80px);
    }
    canvas{background:#2b2e36;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,.6);display:block}
    .err{color:#ffb4b4;padding:10px 14px}
    @media (max-width: 640px){ .toolbar{gap:6px} .toolbar .spacer{display:none} }
  </style>

  <!-- PDF.js via CDN (no local build files needed) -->
  <script type="module">
    import * as pdfjs from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.mjs";
    pdfjs.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.worker.mjs";

    // -------- DOM helpers
    const qs = (k, d="") => new URL(location.href).searchParams.get(k) ?? d; // RAW (do not decode)
    const el = (tag, props={}, ...kids) => {
      const n = document.createElement(tag);
      Object.assign(n, props);
      kids.forEach(k => n.append(k));
      return n;
    };

    // -------- Build UI
    const bar = el("div", { className:"toolbar" });
    const prev = el("button", { textContent:"← Prev", title:"Previous page" });
    const next = el("button", { textContent:"Next →", title:"Next page" });
    const pageIn = el("input", { type:"number", min:"1", value:"1", title:"Page number" });
    const total = el("span", { className:"label", textContent:"/ ?" });
    const scaleSel = el("select", { title:"Zoom" });
    [
      ["page-width","Fit width"],
      ["page-fit","Fit page"],
      ["actual","Actual size"],
      ["50","50%"],["75","75%"],["100","100%"],["125","125%"],["150","150%"],["200","200%"],["300","300%"]
    ].forEach(([v,t]) => scaleSel.append(el("option",{value:v, textContent:t})));
    scaleSel.value = "page-width";

    const zOut = el("button", { textContent:"−", title:"Zoom out" });
    const zIn  = el("button", { textContent:"+", title:"Zoom in" });
    const rotateBtn = el("button", { textContent:"⟳ Rotate", title:"Rotate 90°" });
    const spacer = el("div", { className:"spacer" });
    const openRaw = el("a", { id:"openRaw", textContent:"Open in new tab", target:"_blank", rel:"noopener" });

    bar.append(prev,next,pageIn,total,scaleSel,zOut,zIn,rotateBtn,spacer,openRaw);
    document.addEventListener("DOMContentLoaded",()=>document.body.prepend(bar));

    const viewer = el("div", { id:"viewer" });
    const canvas = el("canvas");
    const ctx = canvas.getContext("2d", { alpha:false });
    viewer.append(canvas);
    document.addEventListener("DOMContentLoaded",()=>document.body.append(viewer));

    // -------- State
    let pdfDoc=null, page=1, rotation=0;
    let zoomMode="page-width";    // "page-width" | "page-fit" | "actual" | <number percentage>
    let manualScale=1.0;          // used when zoomMode is numeric or we adjust with +/-.
    const ZMIN=0.2, ZMAX=6.0;

    // Use raw (URL-encoded) ?file= so spaces (%20) are preserved.
    const rawFileParam = qs("file","");
    if (rawFileParam) openRaw.href = decodeMaybe(rawFileParam);

    function decodeMaybe(s){ try{ return decodeURIComponent(s); } catch{ return s; } }

    // Compute scale based on mode + container size + page size
    function computeScaleFor(pageViewport) {
      const containerW = Math.min(viewer.clientWidth, window.innerWidth) - 36; // padding
      const containerH = viewer.clientHeight > 0 ? (viewer.clientHeight - 36) : (window.innerHeight - 140);
      switch (zoomMode) {
        case "page-width": return clamp(containerW / pageViewport.width, ZMIN, ZMAX);
        case "page-fit":   return clamp(Math.min(containerW / pageViewport.width, containerH / pageViewport.height), ZMIN, ZMAX);
        case "actual":     return 1.0;
        default: {
          const num = Number(zoomMode);
          if (!Number.isFinite(num) || num <= 0) return 1.0;
          return clamp(num / 100, ZMIN, ZMAX);
        }
      }
    }
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    async function render() {
      if (!pdfDoc) return;
      const p = await pdfDoc.getPage(page);

      // rotation
      const rot = (p.rotate + rotation) % 360;
      const baseVp = p.getViewport({ scale:1, rotation:rot });
      const scale = computeScaleFor(baseVp);

      // HiDPI crispness
      const dpr = window.devicePixelRatio || 1;
      const vp  = p.getViewport({ scale: scale * dpr, rotation: rot });

      // canvas size in device pixels, CSS size in CSS pixels
      canvas.width  = Math.floor(vp.width);
      canvas.height = Math.floor(vp.height);
      canvas.style.width  = Math.floor(vp.width  / dpr) + "px";
      canvas.style.height = Math.floor(vp.height / dpr) + "px";

      await p.render({ canvasContext: ctx, viewport: vp }).promise;

      // UI state
      pageIn.value = String(page);
      total.textContent = `/ ${pdfDoc.numPages}`;
      prev.disabled = page<=1; next.disabled = page>=pdfDoc.numPages;
    }

    async function load() {
      if (!rawFileParam) {
        viewer.innerHTML = '<div class="err">Missing ?file= URL.</div>'; return;
      }
      try {
        const task = pdfjs.getDocument(rawFileParam); // keep encoded
        pdfDoc = await task.promise;
        page = clamp(page,1,pdfDoc.numPages);
        await render();
      } catch (e) {
        console.error(e);
        viewer.innerHTML = '<div class="err">Could not load PDF at <code>'+decodeMaybe(rawFileParam)+
                           '</code>. Make sure the file exists and the path is correct.</div>';
      }
    }

    // -------- Controls
    prev.addEventListener("click", async ()=>{ if (page>1){ page--; await render(); }});
    next.addEventListener("click", async ()=>{ if (page<pdfDoc.numPages){ page++; await render(); }});

    pageIn.addEventListener("change", async ()=>{
      const n = clamp(parseInt(pageIn.value||"1",10),1,pdfDoc.numPages||1);
      if (n!==page){ page=n; await render(); }
    });

    scaleSel.addEventListener("change", async ()=>{
      zoomMode = scaleSel.value;
      await render();
    });

    zIn.addEventListener("click", async ()=>{
      // Switch to numeric zoom around current effective scale
      zoomMode = String(Math.round(currentScalePct() * 1.2));
      await render();
      syncScaleSel();
    });

    zOut.addEventListener("click", async ()=>{
      zoomMode = String(Math.round(currentScalePct() / 1.2));
      await render();
      syncScaleSel();
    });

    rotateBtn.addEventListener("click", async ()=>{
      rotation = (rotation + 90) % 360;
      await render();
    });

    // Ctrl/Cmd + wheel to zoom
    viewer.addEventListener("wheel", async (e)=>{
      if (!(e.ctrlKey || e.metaKey)) return;
      e.preventDefault();
      if (e.deltaY < 0) {
        zoomMode = String(Math.round(currentScalePct() * 1.1));
      } else {
        zoomMode = String(Math.round(currentScalePct() / 1.1));
      }
      await render();
      syncScaleSel();
    }, { passive:false });

    // Keyboard: +/- for zoom, arrows for page
    window.addEventListener("keydown", async (e)=>{
      if (e.key === "+" || e.key === "=") { zoomMode = String(Math.round(currentScalePct() * 1.2)); await render(); syncScaleSel(); }
      if (e.key === "-" || e.key === "_") { zoomMode = String(Math.round(currentScalePct() / 1.2)); await render(); syncScaleSel(); }
      if (e.key === "ArrowRight") { if (page<pdfDoc.numPages){ page++; await render(); } }
      if (e.key === "ArrowLeft")  { if (page>1){ page--; await render(); } }
      if (e.key === "0") { zoomMode="actual"; scaleSel.value="actual"; await render(); }
    });

    // Keep fit modes responsive
    window.addEventListener("resize", ()=>{ if (pdfDoc && (zoomMode==="page-width" || zoomMode==="page-fit")) render(); });

    function currentScalePct() {
      // Estimate current CSS scale from rendered canvas CSS width vs unscaled page width
      // Get current page size @ 1.0 to derive percentage
      if (!pdfDoc) return 100;
      // We can't block to load page again; approximate from CSS width and rotation
      // More robust: compute using last render sizes:
      const dpr = window.devicePixelRatio || 1;
      const cssWidth = parseFloat(canvas.style.width) || (canvas.width / dpr);
      const cssHeight = parseFloat(canvas.style.height) || (canvas.height / dpr);
      // Heuristic: compare against canvas size when scale=1 would be ??? Unknown without page dims.
      // We'll map numeric zoomMode if set, else return 100 for fit modes.
      if (zoomMode==="page-width" || zoomMode==="page-fit") {
        // Return 100 so +/- jumps to numeric from fit modes smoothly
        return 100;
      }
      const num = Number(zoomMode);
      return Number.isFinite(num) ? num : 100;
    }

    function syncScaleSel() {
      // If zoomMode matches one of the presets, reflect it; else leave as-is
      const preset = ["page-width","page-fit","actual","50","75","100","125","150","200","300"];
      if (preset.includes(zoomMode)) scaleSel.value = zoomMode;
      else scaleSel.value = "actual"; // show a sane value
    }

    load();
  </script>
</head>
<body></body>
</html>

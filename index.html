<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My PDFs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#ffffff; --ink:#101114; --muted:#5f6673; --border:#e3e6ee; --panel:#f7f8fb; --accent:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:var(--bg);
      font:14.5px/1.55 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    header{
      padding:18px 0 6px; margin-bottom:12px; border-bottom:1px solid var(--border);
    }
    h1{
      margin:0 0 8px; font-size:20px; letter-spacing:.2px;
    }
    .muted{color:var(--muted); font-size:13px}
    .bar{
      display:flex; flex-wrap:wrap; align-items:center; gap:10px;
      padding:14px; background:var(--panel); border:1px solid var(--border); border-radius:10px;
      margin:16px 0 18px;
    }
    label{font-weight:600}
    select, input[type="text"]{
      min-width:260px; padding:8px 10px; border:1px solid var(--border); border-radius:8px; outline:none;
      background:#fff;
    }
    .btn{
      padding:8px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; text-decoration:none; color:var(--ink);
    }
    .btn.primary{border-color:transparent; background:var(--accent); color:#fff}
    .note{margin:2px 0 0; color:var(--muted); font-size:12.5px}
    .viewer{
      border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff;
      box-shadow:0 4px 18px rgba(0,0,0,.04);
    }
    iframe{
      display:block; width:100%; height:78vh; border:0;
      background:#fff;
    }
    footer{
      color:var(--muted); font-size:12.5px; text-align:center; padding:18px 0 8px;
    }

    /* CREDIT */
    footer::after{
      content:"Math Lessons used by permission. Credit to Mr. Pitocco.";
      display:block;
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }

    @media (max-width:640px){
      .wrap{padding:16px}
      iframe{height:72vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>My PDFs</h1>
      <div class="muted">Pick a file from the list to view it below. Upload new PDFs to <code>/pdfs/</code> and list them in <code>/pdfs/manifest.json</code>.</div>
    </header>

    <div class="bar" role="region" aria-label="PDF controls">
      <label for="pdfSelect">Select a file:</label>
      <select id="pdfSelect" aria-label="Select a PDF to view"></select>

      <a id="openBtn" class="btn" target="_blank" rel="noopener">Open in new tab</a>
      <a id="downloadBtn" class="btn" download>Download</a>

      <span class="muted" id="currentPath" style="margin-left:auto;"></span>
    </div>

    <div id="warn" class="muted" style="display:none; margin:0 0 10px;"></div>

    <div class="viewer">
      <iframe
        id="viewer"
        title="PDF viewer"
        src=""
        allowfullscreen
      ></iframe>
    </div>

    <footer>
      <div>Simple PDF library Â· Powered by Pierre's big brain</div>
    </footer>
  </div>

  <script>
    (function () {
      const select = document.getElementById('pdfSelect');
      const iframe = document.getElementById('viewer');
      const openBtn = document.getElementById('openBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const warn = document.getElementById('warn');
      const currentPath = document.getElementById('currentPath');

      function toEncodedAbs(path) {
        if (!path) return "";
        if (!path.startsWith('/')) path = '/' + path.replace(/^\/+/, '');
        return encodeURIComponent(path).replace(/%2F/g, '%2F');
      }

      function setViewer(path) {
        if (!path) return;
        const encoded = toEncodedAbs(path);
        iframe.src = `pdfjs/web/viewer.html?v=5&file=${encoded}#zoom=page-width`;
        openBtn.href = path;
        downloadBtn.href = path;
        downloadBtn.download = path.split('/').pop() || 'file.pdf';
        currentPath.textContent = path;
      }

      function populate(items) {
        select.innerHTML = '';
        items.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.file;
          opt.textContent = item.title || item.file.split('/').pop();
          select.appendChild(opt);
        });
      }

      function fallback(reason) {
        warn.style.display = 'block';
        warn.textContent = reason || 'Could not load manifest.json.';
      }

      fetch('/pdfs/manifest.json', { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error();
          return r.json();
        })
        .then(data => {
          const items = Array.isArray(data.items) ? data.items : [];
          if (!items.length) return fallback('No PDFs listed in manifest.');
          populate(items);
          setViewer(select.value);
          select.addEventListener('change', () => setViewer(select.value));
        })
        .catch(() => fallback('Could not load /pdfs/manifest.json.'));
    })();
  </script>
</body>
</html>
